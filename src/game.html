<html>
<head>
<title>Learn Python!</title>
<style type="text/css">
@import url(assets/css/styles.css);
</style>
<script type='text/javascript' src='https://cdn.firebase.com/v0/firebase.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
<script type='text/javascript'
        src='https://cdn.firebase.com/v0/firebase-simple-login.js'>
</script>
<script language="Javascript" type="text/javascript" src="http://www.cdolivet.com/editarea/editarea/edit_area/edit_area_full.js"></script>
<script src="repl.it/jsrepl/jsrepl.js" id="jsrepl-script"></script>
<script src="simulate.js"></script>
<script>
var userObj;
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}
var id = getParameterByName('id');
if(id==null) {
	document.location = "index.html";
}
var root = "https://learn-python.firebaseIO.com";
var rootRef = new Firebase(root + "/");
var auth = new FirebaseSimpleLogin(rootRef, function(error, user) {
  if (error) {
    // an error occurred while attempting login
    console.log(error);
  } else if (user) {
  	userObj = user;
    // user authenticated with Firebase
    console.log('User ID: ' + user.id + ', Provider: ' + user.provider);
  } else {
    document.location="index.html";
  }
});
</script>
<script>
var useEditArea = false;

if(useEditArea) {
editAreaLoader.init({
			id: "p1code"	// id of the textarea to transform		
			,start_highlight: true	// if start with highlight
			,allow_resize: "no"
			,allow_toggle: false
			,word_wrap: true
			,language: "en"
			,syntax: "python"	
		});

editAreaLoader.init({
			id: "p2code"	// id of the textarea to transform		
			,start_highlight: true	// if start with highlight
			,allow_resize: "no"
			,allow_toggle: false
			,word_wrap: true
			,language: "en"
			,syntax: "python"	
		});
}

</script>
</head>
<body>
<div id="background"></div>
<div id="front">Waiting...</div>
<h1>Learn Python!</h1>
<div id="main">
	<div id="code-left">
	<textarea id="p1code" class="code" /></textarea><br />
	<button id="p1s" class="greybtn">Player 1: Ready?</button>
	</div>
	<div id="code-right">
	<textarea id="p2code" class="code" /></textarea><br />
	<button id="p2s" class="greybtn">Player 2: Ready?</button>
	</div>
	<div id="map">
	<canvas id="canvas" style="border: 1px solid black;"></canvas>
	</div>
</div>
<div id="sidebar">
<h2>Level</h2>
<h3>Objective</h3>
Get player 1 to the center before player 2 does!
<h2>Chat</h2>
<div id="messagesDiv">
<input type="text" id="messageInput" placeholder="Message" />
</div>
<script>
var root = "https://learn-python.firebaseIO.com";
var gameRoot = root + "/games/" + id;
var rootRef = new Firebase(gameRoot);
var code1DataRef = new Firebase(gameRoot + "/p1code");
var code2DataRef = new Firebase(gameRoot + "/p2code");
var messagesRef = new Firebase(gameRoot + "/messages");
var gameStarted = false;
var playerOne = false;
rootRef.on('value', function(ss) {
	console.log(ss.val());
	if(!gameStarted && ss.val().p1 !== undefined && ss.val().p2 !== undefined) {
		gameStarted = true;
		if(userObj.id != ss.val().p1) {
			playerOne = false;
			$("#p1code").prop("disabled",true);
			$("#p1s").prop("disabled",true);
		}
		if(userObj.id != ss.val().p2) {
			playerOne = 
			$("#p2code").prop("disabled",true);
			$("#p2s").prop("disabled",true);
		}
		//$('#background, #front').fadeOut(200);
	}
	if(ss.val().p1ready == true) {
		toggleReady("#p1s");
	}
	if(ss.val().p2ready == true) {
		toggleReady("#p2s");
	}
	if(ss.val().p1ready == true && ss.val().p2ready == true) {
		console.log("Both players are ready, execute the code");
		runSimulation([$("#p1code").val(), $("#p2code").val()],drawBoardObj,function(err){console.log("Stderr: " + err);});
	}
});

$("#p1s").on('click', function() {
	toggleReady("#p1s");
	rootRef.child('p1ready').set(true);
});
$("#p2s").on('click', function() {
	toggleReady("#p2s");
	rootRef.child('p2ready').set(true);
});

code1DataRef.on('value', function(snapshot) {
	var code1 = snapshot.val();
	if(useEditArea) {
	editAreaLoader.setValue("p1code", code1);
	}
	else {
		$("#p1code").val(code1);
	}
});
$('#p1code').keyup(function(e) {
	var code1 = $('#p1code').val();
	code1DataRef.set(code1);
});
$('#p2code').keyup(function(e) {
	var code2 = $('#p2code').val();
	code2DataRef.set(code2);
});
code2DataRef.on('value', function(snapshot) {
	$('#p2code').val(snapshot.val());
});

$('#messageInput').keypress(function(e) {
	if(e.keyCode==13) {
		var msgText = $('#messageInput').val();
		messagesRef.push({player: userObj.name, text: msgText});
		$('#messageInput').val('');
	}
});
messagesRef.on('child_added', function(snapshot) {
	var message = snapshot.val();
	displayChatMessage(message.player, message.text);
});

function toggleReady(id) {
	$(id).toggleClass("greybtn", false);
	$(id).toggleClass("greenbtn",true);}

function toggleNotReady(id) {
	$(id).toggleClass("greybtn", true);
	$(id).toggleClass("greenbtn",false);
}


function displayChatMessage(name, text) {
	    $('<div/>').text(text).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
        $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
}
function showGame(){
	loadLevelCode("py/level1.py", function(){$('#background, #front').fadeOut(200);});	
}
</script>
<script>
var width = 1216;
var height = 704;
var cols = 19;
var rows = 11;
var random = true;
var ctx;
var noob_mode = true;
var board = [];
var prefix = "assets/img/";
var dict = {"W": "water.png", "L": "grass.png", "wall": "hole.png"};
var images = {};
var base;
var tileVariant = [];
var variantLocs = {0: {x: 32, y: 96}, 1: {x: 0, y: 160}, 2: {x: 32, y: 160}, 3: {x: 64, y: 160}};
function tileWidth() {
	return width/cols;
}
function tileHeight() {
	return height/rows;
}
for(var key in dict) {
	base = new Image();
	base.src = prefix + dict[key];
	images[key] = base;
}


for(var i=0;i<rows;i++) //Initialize board
{
	board[i]=[];
	tileVariant[i]=[];
	for(var j=0;j<cols;j++) {
		board[i][j] = 0;
		tileVariant[i][j] = Math.floor(Math.random() * 4.0);
	}
}

function drawTile(row,col,key)
{
	var startingX = col*tileWidth();
	var startingY = row*tileHeight();
	var tv = variantLocs[tileVariant[row][col]];
	ctx.drawImage(images[key],tv.x, tv.y,32,32,startingX,startingY, tileWidth(),tileHeight());
}

function drawBoard() {
	ctx.clearRect(0,0,canvas.width,canvas.height);

	if(false) {
		for(var i=1;i<cols;i++){ //Draw columns
			ctx.moveTo(width/cols*i, 0);
			ctx.lineTo(width/cols*i, height);
			ctx.stroke();
		}
		for(var i=1;i<rows;i++){ //Draw rows
			ctx.moveTo(0,height/rows*i);
			ctx.lineTo(width, height/rows*i);
			ctx.stroke();
		}
	}
	if(random) {
		for(var i=0;i<rows;i++) {
			for(var j=0;j<cols;j++) {
				drawTile(i,j,Math.random() < 0.3 ? "W" : Math.random() < 0.9 ? "L" : "wall");
			}
		}
	}
}

function drawPlayer(i,j,id,dir) {
	return;
}

function drawBoardObj(json) {
	for(var i=0;i<rows;i++) {
		for(var j=0;j<cols;j++) {
			var curr = json[i][j];
			drawTile(i,j,"L");
			if(curr.entity == "player") {
				drawTile(i,j,"L");
				drawPlayer(i,j,curr.entity.info.name,curr.entity.info.direction);
			}
			else if(curr.entity == "water") {
				drawTile(i,j,"W");
			}
			else if(curr.entity == "wall") {
				drawTile(i,j,"wall");
			}
		}
	}
}

$(document).ready(function(){
	var canvas = document.getElementById('canvas');
	canvas.height = height;
	canvas.width = width;
	if (canvas.getContext) {
		ctx = canvas.getContext("2d");
		drawBoard();
		window.setTimeout(drawBoard,1000);
	}
	$(canvas).mousedown(function myDown(e) 
	{
		var position = $(canvas).position();
		var x = e.pageX-position.left;
		var y = e.pageY-position.top;
		var col = Math.floor(x / tileWidth());
		var row = Math.floor(y / tileHeight());
	});	
});
</script>
</body>
</html>